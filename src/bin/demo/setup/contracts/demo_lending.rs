//! # `demo_lending`
//!
//! The following contains a sample lending protocol vulnerable to reentrancy.
//! The protocol accepts eth deposits, withdrawal and borrowing.
//!
//! The assertion checks that our output balance is not more than our balance
//! deposited inside of the protocol.

use assertion_executor::{
    db::SharedDB,
    primitives::{
        Account,
        AccountInfo,
        Address,
        AssertionContract,
        BlockChanges,
        BlockEnv,
        Bytecode,
        TxEnv,
        TxKind,
        U256,
    },
    AssertionExecutor,
};

use revm::primitives::{
    bytes,
    fixed_bytes,
    keccak256,
    Bytes,
    FixedBytes,
};

/// Address of the lending contract
pub const LENDING_ADDRESS: Address = Address::new([2u8; 20]);
pub const LENDING_CODE: Bytes = bytes!("60806040526004361061007b5760003560e01c8063402d88831161004e578063402d888314610130578063c399ec8814610138578063c5ebeaec1461015a578063d0e30db01461017a57600080fd5b80630941cb3d1461008057806314a6bf0f146100bf57806327e235e3146100e15780632e1a7d4d1461010e575b600080fd5b34801561008c57600080fd5b506100ad61009b366004610549565b60016020526000908152604090205481565b60405190815260200160405180910390f35b3480156100cb57600080fd5b50336000908152600160205260409020546100ad565b3480156100ed57600080fd5b506100ad6100fc366004610549565b60006020819052908152604090205481565b34801561011a57600080fd5b5061012e610129366004610579565b610182565b005b61012e610276565b34801561014457600080fd5b50336000908152602081905260409020546100ad565b34801561016657600080fd5b5061012e610175366004610579565b61037d565b61012e6104a3565b3360009081526020819052604090205461019d9082906105a8565b3360008181526020819052604080822093909355915183908381818185875af1925050503d80600081146101ed576040519150601f19603f3d011682016040523d82523d6000602084013e6101f2565b606091505b505090508061023d5760405162461bcd60e51b815260206004820152601260248201527108cc2d2d8cac840e8de40e6cadcc8408aa8960731b60448201526064015b60405180910390fd5b60405182815233907f7084f5476618d8e60b11ef0d7d3f06914655adb8793e28ff7f018d4c76d505d59060200160405180910390a25050565b600034116102bf5760405162461bcd60e51b8152602060048201526016602482015275135d5cdd081c995c185e481cdbdb5948185b5bdd5b9d60521b6044820152606401610234565b336000908152600160205260409020543411156103125760405162461bcd60e51b81526020600482015260116024820152700a4cae0c2f2d2dcce40e8dede40daeac6d607b1b6044820152606401610234565b3360009081526001602052604090205461032d9034906105a8565b33600081815260016020526040908190209290925590517f0516911bcc3a0a7412a44601057c0a0a1ec628bde049a84284bc428866534488906103739034815260200190565b60405180910390a2565b33600090815260208190526040812054600a9061039b9060096105c1565b6103a591906105d8565b604051909150600090339084908381818185875af1925050503d80600081146103ea576040519150601f19603f3d011682016040523d82523d6000602084013e6103ef565b606091505b50509050806104355760405162461bcd60e51b815260206004820152601260248201527108cc2d2d8cac840e8de40e6cadcc8408aa8960731b6044820152606401610234565b336000908152600160205260409020546104509084906105fa565b33600081815260016020526040908190209290925590517fac59582e5396aca512fa873a2047e7f4c80f8f55d4a06cb34a78a0187f62719f906104969086815260200190565b60405180910390a2505050565b600034116104eb5760405162461bcd60e51b815260206004820152601560248201527409aeae6e840c8cae0dee6d2e840e6dedaca408aa89605b1b6044820152606401610234565b336000908152602081905260409020546105069034906105fa565b3360008181526020818152604091829020939093555134815290917f2da466a7b24304f47e87fa2e1e5a81b9831ce54fec19055ce277ca2f39ba42c49101610373565b60006020828403121561055b57600080fd5b81356001600160a01b038116811461057257600080fd5b9392505050565b60006020828403121561058b57600080fd5b5035919050565b634e487b7160e01b600052601160045260246000fd5b818103818111156105bb576105bb610592565b92915050565b80820281158282048414176105bb576105bb610592565b6000826105f557634e487b7160e01b600052601260045260246000fd5b500490565b808201808211156105bb576105bb61059256fea2646970667358221220444ec89b44074d636dc5ba38af19ee6029cea30e0f957f60f24250b0a7997c6864736f6c634300081a0033");

pub fn lending_acct_info() -> AccountInfo {
    AccountInfo {
        balance: U256::from(0xBEEF),
        nonce: 0,
        code_hash: keccak256(LENDING_CODE),
        code: Some(Bytecode::LegacyRaw(LENDING_CODE)),
    }
}

pub fn lending_call() -> TxEnv {
    TxEnv {
        transact_to: TxKind::Call(LENDING_ADDRESS),
        data: fixed_bytes!("d0e30db0").into(),
        ..TxEnv::default()
    }
}

/// Deploys the fork test contract.
pub fn deploy_demo_lending(
    executor: &mut AssertionExecutor<SharedDB<5>>,
    block_changes: &mut BlockChanges,
) {
    // Fork test contract to block_changes
    block_changes.state_changes.insert(
        LENDING_ADDRESS,
        Account {
            info: lending_acct_info(),
            ..Default::default()
        },
    );

    // Deploy fork_test contract
    let transactions = vec![lending_call()];

    let mut fork_db = executor.db.fork();

    let env = BlockEnv {
        basefee: FixedBytes::new([0; 32]).into(),
        ..Default::default()
    };

    transactions
        .into_iter()
        .fold(block_changes, |block_changes, tx_env| {
            let changes = executor
                .execute_forked_tx(env.clone(), tx_env, &mut fork_db)
                .unwrap()
                .1;
            block_changes.state_changes.extend(changes);
            block_changes
        });
}

/// Constructor assertion bytecode
pub const LENDING_ASSERTION_CODE: Bytes = bytes!("6080604052600080546001600160a01b031916734461812e00718ff8d80929e3bf595aeaaa7b881e179055600d805460ff199081166001908117909255602080549091169091179055348015605357600080fd5b50610f45806100636000396000f3fe608060405234801561001057600080fd5b50600436106100cf5760003560e01c8063916a17c61161008c578063ba414fa611610066578063ba414fa614610166578063d509b16c1461017e578063e20c9f7114610188578063fa7626d41461019057600080fd5b8063916a17c614610141578063b0464fdc14610156578063b5508aa91461015e57600080fd5b80631ed7831c146100d45780632ade3880146100f25780633e5e3c23146101075780633f7286f41461010f57806366d9a9a01461011757806385226c811461012c575b600080fd5b6100dc61019d565b6040516100e99190610b9f565b60405180910390f35b6100fa6101ff565b6040516100e99190610c31565b6100dc610341565b6100dc6103a1565b61011f610401565b6040516100e99190610d43565b61013461056e565b6040516100e99190610dc3565b61014961063e565b6040516100e99190610e1c565b610149610724565b61013461080a565b61016e6108da565b60405190151581526020016100e9565b61018661097e565b005b6100dc610b3f565b60205461016e9060ff1681565b606060178054806020026020016040519081016040528092919081815260200182805480156101f557602002820191906000526020600020905b81546001600160a01b031681526001909101906020018083116101d7575b5050505050905090565b6060601f805480602002602001604051908101604052809291908181526020016000905b8282101561033857600084815260208082206040805180820182526002870290920180546001600160a01b03168352600181018054835181870281018701909452808452939591948681019491929084015b8282101561032157838290600052602060002001805461029490610e95565b80601f01602080910402602001604051908101604052809291908181526020018280546102c090610e95565b801561030d5780601f106102e25761010080835404028352916020019161030d565b820191906000526020600020905b8154815290600101906020018083116102f057829003601f168201915b505050505081526020019060010190610275565b505050508152505081526020019060010190610223565b50505050905090565b606060198054806020026020016040519081016040528092919081815260200182805480156101f5576020028201919060005260206000209081546001600160a01b031681526001909101906020018083116101d7575050505050905090565b606060188054806020026020016040519081016040528092919081815260200182805480156101f5576020028201919060005260206000209081546001600160a01b031681526001909101906020018083116101d7575050505050905090565b6060601c805480602002602001604051908101604052809291908181526020016000905b82821015610338578382906000526020600020906002020160405180604001604052908160008201805461045890610e95565b80601f016020809104026020016040519081016040528092919081815260200182805461048490610e95565b80156104d15780601f106104a6576101008083540402835291602001916104d1565b820191906000526020600020905b8154815290600101906020018083116104b457829003601f168201915b505050505081526020016001820180548060200260200160405190810160405280929190818152602001828054801561055657602002820191906000526020600020906000905b82829054906101000a900460e01b6001600160e01b031916815260200190600401906020826003010492830192600103820291508084116105185790505b50505050508152505081526020019060010190610425565b6060601b805480602002602001604051908101604052809291908181526020016000905b828210156103385783829060005260206000200180546105b190610e95565b80601f01602080910402602001604051908101604052809291908181526020018280546105dd90610e95565b801561062a5780601f106105ff5761010080835404028352916020019161062a565b820191906000526020600020905b81548152906001019060200180831161060d57829003601f168201915b505050505081526020019060010190610592565b6060601e805480602002602001604051908101604052809291908181526020016000905b828210156103385760008481526020908190206040805180820182526002860290920180546001600160a01b0316835260018101805483518187028101870190945280845293949193858301939283018282801561070c57602002820191906000526020600020906000905b82829054906101000a900460e01b6001600160e01b031916815260200190600401906020826003010492830192600103820291508084116106ce5790505b50505050508152505081526020019060010190610662565b6060601d805480602002602001604051908101604052809291908181526020016000905b828210156103385760008481526020908190206040805180820182526002860290920180546001600160a01b031683526001810180548351818702810187019094528084529394919385830193928301828280156107f257602002820191906000526020600020906000905b82829054906101000a900460e01b6001600160e01b031916815260200190600401906020826003010492830192600103820291508084116107b45790505b50505050508152505081526020019060010190610748565b6060601a805480602002602001604051908101604052809291908181526020016000905b8282101561033857838290600052602060002001805461084d90610e95565b80601f016020809104026020016040519081016040528092919081815260200182805461087990610e95565b80156108c65780601f1061089b576101008083540402835291602001916108c6565b820191906000526020600020905b8154815290600101906020018083116108a957829003601f168201915b50505050508152602001906001019061082e565b60095460009060ff16156108f2575060095460ff1690565b604051630667f9d760e41b8152737109709ecfa91a80626ff3989d68f67f5b1dd12d600482018190526519985a5b195960d21b602483015260009163667f9d7090604401602060405180830381865afa158015610953573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906109779190610ecf565b1415905090565b6000336001600160a01b031631905060008060008054906101000a90046001600160a01b03166001600160a01b031663a09960eb6040518163ffffffff1660e01b8152600401600060405180830381600087803b1580156109de57600080fd5b505af11580156109f2573d6000803e3d6000fd5b5050505073118dd24a3b0d02f90d8896e242d3838b4d37c1816001600160a01b031663c399ec886040518163ffffffff1660e01b8152600401602060405180830381865afa158015610a48573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610a6c9190610ecf565b915073118dd24a3b0d02f90d8896e242d3838b4d37c1816001600160a01b03166314a6bf0f6040518163ffffffff1660e01b8152600401602060405180830381865afa158015610ac0573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610ae49190610ecf565b9050610af08183610ee8565b831115610b3a5760405162461bcd60e51b8152602060048201526014602482015273496e73756666696369656e742062616c616e636560601b604482015260640160405180910390fd5b505050565b606060168054806020026020016040519081016040528092919081815260200182805480156101f5576020028201919060005260206000209081546001600160a01b031681526001909101906020018083116101d7575050505050905090565b602080825282518282018190526000918401906040840190835b81811015610be05783516001600160a01b0316835260209384019390920191600101610bb9565b509095945050505050565b6000815180845260005b81811015610c1157602081850181015186830182015201610bf5565b506000602082860101526020601f19601f83011685010191505092915050565b6000602082016020835280845180835260408501915060408160051b86010192506020860160005b82811015610cf157603f19878603018452815180516001600160a01b03168652602090810151604082880181905281519088018190529101906060600582901b88018101919088019060005b81811015610cd757605f198a8503018352610cc1848651610beb565b6020958601959094509290920191600101610ca5565b509197505050602094850194929092019150600101610c59565b50929695505050505050565b600081518084526020840193506020830160005b82811015610d395781516001600160e01b031916865260209586019590910190600101610d11565b5093949350505050565b6000602082016020835280845180835260408501915060408160051b86010192506020860160005b82811015610cf157603f198786030184528151805160408752610d916040880182610beb565b9050602082015191508681036020880152610dac8183610cfd565b965050506020938401939190910190600101610d6b565b6000602082016020835280845180835260408501915060408160051b86010192506020860160005b82811015610cf157603f19878603018452610e07858351610beb565b94506020938401939190910190600101610deb565b6000602082016020835280845180835260408501915060408160051b86010192506020860160005b82811015610cf157868503603f19018452815180516001600160a01b03168652602090810151604091870182905290610e7f90870182610cfd565b9550506020938401939190910190600101610e44565b600181811c90821680610ea957607f821691505b602082108103610ec957634e487b7160e01b600052602260045260246000fd5b50919050565b600060208284031215610ee157600080fd5b5051919050565b80820180821115610f0957634e487b7160e01b600052601160045260246000fd5b9291505056fea26469706673582212203aa0e4f6271f5838ee4b64252eae3f3edef45b4dc9eab32f7036b167d10977d664736f6c634300081a0033");

pub fn lending_assertion() -> AssertionContract {
    AssertionContract {
        code: Bytecode::LegacyRaw(LENDING_ASSERTION_CODE),
        code_hash: keccak256(LENDING_ASSERTION_CODE),
        fn_selectors: vec![fixed_bytes!("d509b16c")],
    }
}
