use crate::{
    db::{
        multi_fork_db::{
            ForkError,
            ForkId,
            MultiForkDb,
        },
        DatabaseRef,
    },
    primitives::{
        address,
        bytes,
        Address,
        Bytecode,
        Bytes,
        JournaledState,
        U256,
    },
};

use alloy_sol_types::{
    sol,
    SolCall,
    SolError,
};

use revm::{
    interpreter::{
        CallInputs,
        CallOutcome,
        CreateInputs,
        CreateOutcome,
        Gas,
        InstructionResult,
        Interpreter,
        InterpreterResult,
    },
    precompile::{
        PrecompileSpecId,
        Precompiles,
    },
    primitives::SpecId,
    EvmContext,
    InnerEvmContext,
    Inspector,
};

/// Precompile address
/// address(uint160(uint256(keccak256("Kim Jong Un Sucks"))))
pub const PRECOMPILE_ADDRESS: Address = address!("4461812e00718ff8D80929E3bF595AEaaa7b881E");

sol! {
    interface PhEvm {
        //Forks to the state prior to the assertion triggering transaction.
        function forkPreState() external;

        //Forks to the state after the assertion triggering transaction.
        function forkPostState() external;
    }

    //Default require error
    error Error(string);
}

/// PhEvmInspector is an inspector for supporting the PhEvm precompiles.
pub struct PhEvmInspector {
    init_journaled_state: JournaledState,
}

impl PhEvmInspector {
    /// Create a new PhEvmInspector.
    pub fn new(spec_id: SpecId, db: &mut MultiForkDb<impl DatabaseRef>) -> Self {
        insert_precompile_account(db);

        let init_journaled_state = JournaledState::new(
            spec_id,
            Precompiles::new(PrecompileSpecId::from_spec_id(spec_id))
                .addresses()
                .copied()
                .collect(),
        );
        PhEvmInspector {
            init_journaled_state,
        }
    }

    /// Execute precompile functions for the PhEvm.
    pub fn execute_precompile(
        &self,
        context: &mut EvmContext<&mut MultiForkDb<impl DatabaseRef>>,
        inputs: &mut CallInputs,
    ) -> CallOutcome {
        let gas = Gas::new(inputs.gas_limit);

        match inputs
            .input
            .as_ref()
            .get(0..4)
            .unwrap_or_default()
            .try_into()
            .unwrap_or_default()
        {
            PhEvm::forkPreStateCall::SELECTOR => {
                let InnerEvmContext {
                    ref mut db,
                    ref mut journaled_state,
                    ..
                } = context.inner;

                let result =
                    db.switch_fork(ForkId::PreTx, journaled_state, &self.init_journaled_state);
                fork_result_to_call_outcome(result, gas)
            }
            PhEvm::forkPostStateCall::SELECTOR => {
                let InnerEvmContext {
                    ref mut db,
                    ref mut journaled_state,
                    ..
                } = context.inner;

                let result =
                    db.switch_fork(ForkId::PostTx, journaled_state, &self.init_journaled_state);

                fork_result_to_call_outcome(result, gas)
            }
            _ => {
                CallOutcome {
                    result: InterpreterResult {
                        result: InstructionResult::Revert,
                        output: Bytes::default(),
                        gas,
                    },
                    memory_offset: 0..0,
                }
            }
        }
    }
}

/// Convert a fork result to a call outcome.
/// Uses the default require [`Error`] signature for encoding revert messages.
fn fork_result_to_call_outcome(result: Result<(), ForkError>, gas: Gas) -> CallOutcome {
    match result {
        Ok(()) => {
            CallOutcome {
                result: InterpreterResult {
                    result: InstructionResult::Stop,
                    output: Bytes::default(),
                    gas,
                },
                memory_offset: 0..0,
            }
        }
        Err(e) => {
            CallOutcome {
                result: InterpreterResult {
                    result: InstructionResult::Revert,
                    output: Error::abi_encode(&Error { _0: e.to_string() }).into(),
                    gas,
                },
                memory_offset: 0..0,
            }
        }
    }
}

impl<DB: DatabaseRef> Inspector<&mut MultiForkDb<DB>> for PhEvmInspector {
    fn initialize_interp(
        &mut self,
        _interp: &mut Interpreter,
        _context: &mut EvmContext<&mut MultiForkDb<DB>>,
    ) {
    }

    fn step(&mut self, _interp: &mut Interpreter, _context: &mut EvmContext<&mut MultiForkDb<DB>>) {
    }

    fn step_end(
        &mut self,
        _interp: &mut Interpreter,
        _context: &mut EvmContext<&mut MultiForkDb<DB>>,
    ) {
    }

    fn call_end(
        &mut self,
        _context: &mut EvmContext<&mut MultiForkDb<DB>>,
        _inputs: &CallInputs,
        outcome: CallOutcome,
    ) -> CallOutcome {
        outcome
    }

    fn create_end(
        &mut self,
        _context: &mut EvmContext<&mut MultiForkDb<DB>>,
        _inputs: &CreateInputs,
        outcome: CreateOutcome,
    ) -> CreateOutcome {
        outcome
    }

    fn call(
        &mut self,
        context: &mut EvmContext<&mut MultiForkDb<DB>>,
        inputs: &mut CallInputs,
    ) -> Option<CallOutcome> {
        if inputs.target_address == PRECOMPILE_ADDRESS {
            return Some(self.execute_precompile(context, inputs));
        }
        None
    }

    fn create(
        &mut self,
        _context: &mut EvmContext<&mut MultiForkDb<DB>>,
        _inputs: &mut CreateInputs,
    ) -> Option<CreateOutcome> {
        None
    }

    fn selfdestruct(&mut self, _contract: Address, _target: Address, _value: U256) {}
}

/// Insert the precompile account into the database.
fn insert_precompile_account<T>(db: &mut MultiForkDb<T>) {
    db.active_db.insert_account_info(
        PRECOMPILE_ADDRESS,
        crate::primitives::AccountInfo {
            code: Some(Bytecode::new_raw(bytes!("45"))),
            ..Default::default()
        },
    );
}

#[cfg(test)]
mod test {
    use super::*;
    use crate::{
        db::SharedDB,
        primitives::{
            address,
            BlockEnv,
            Bytecode,
            TxEnv,
            TxKind,
        },
        store::MockStore,
        AssertionExecutor,
    };
    use revm::primitives::bytes;

    #[tokio::test]
    async fn test_fork_switching() {
        let caller = address!("5fdcca53617f4d2b9134b29090c87d01058e27e9");
        let target = address!("118dd24a3b0d02f90d8896e242d3838b4d37c181");

        let db = SharedDB::<0>::new_test();

        let mut assertion_store = MockStore::default();

        let mut fork_db = db.fork();

        // Write test assertion to assertion store
        // deployment bytecode of contract-mocks/src/ForkTest.sol:ForkTest
        let assertion_code = bytes!("6080604052600080546001600160a01b031916734461812e00718ff8d80929e3bf595aeaaa7b881e178155600d805460ff19908116600190811790925560208054909116821790556021829055602255611b4690819061005f90396000f3fe608060405234801561001057600080fd5b50600436106100f55760003560e01c806395eff8b511610097578063c09b670611610066578063c09b6706146101b9578063e20c9f71146101c3578063ee846217146101cb578063fa7626d4146101d357600080fd5b806395eff8b51461017c578063b0464fdc14610191578063b5508aa914610199578063ba414fa6146101a157600080fd5b80633f7286f4116100d35780633f7286f41461013557806366d9a9a01461013d57806385226c8114610152578063916a17c61461016757600080fd5b80631ed7831c146100fa5780632ade3880146101185780633e5e3c231461012d575b600080fd5b6101026101e0565b60405161010f9190611750565b60405180910390f35b610120610242565b60405161010f91906117e2565b610102610384565b6101026103e4565b610145610444565b60405161010f91906118f4565b61015a6105b1565b60405161010f9190611974565b61016f610681565b60405161010f91906119cd565b610184610767565b60405161010f9190611a46565b61016f6107f5565b61015a6108db565b6101a96109ab565b604051901515815260200161010f565b6101c1610a4f565b005b610102611313565b6101c1611373565b6020546101a99060ff1681565b6060601780548060200260200160405190810160405280929190818152602001828054801561023857602002820191906000526020600020905b81546001600160a01b0316815260019091019060200180831161021a575b5050505050905090565b6060601f805480602002602001604051908101604052809291908181526020016000905b8282101561037b57600084815260208082206040805180820182526002870290920180546001600160a01b03168352600181018054835181870281018701909452808452939591948681019491929084015b828210156103645783829060005260206000200180546102d790611a60565b80601f016020809104026020016040519081016040528092919081815260200182805461030390611a60565b80156103505780601f1061032557610100808354040283529160200191610350565b820191906000526020600020905b81548152906001019060200180831161033357829003601f168201915b5050505050815260200190600101906102b8565b505050508152505081526020019060010190610266565b50505050905090565b60606019805480602002602001604051908101604052809291908181526020018280548015610238576020028201919060005260206000209081546001600160a01b0316815260019091019060200180831161021a575050505050905090565b60606018805480602002602001604051908101604052809291908181526020018280548015610238576020028201919060005260206000209081546001600160a01b0316815260019091019060200180831161021a575050505050905090565b6060601c805480602002602001604051908101604052809291908181526020016000905b8282101561037b578382906000526020600020906002020160405180604001604052908160008201805461049b90611a60565b80601f01602080910402602001604051908101604052809291908181526020018280546104c790611a60565b80156105145780601f106104e957610100808354040283529160200191610514565b820191906000526020600020905b8154815290600101906020018083116104f757829003601f168201915b505050505081526020016001820180548060200260200160405190810160405280929190818152602001828054801561059957602002820191906000526020600020906000905b82829054906101000a900460e01b6001600160e01b0319168152602001906004019060208260030104928301926001038202915080841161055b5790505b50505050508152505081526020019060010190610468565b6060601b805480602002602001604051908101604052809291908181526020016000905b8282101561037b5783829060005260206000200180546105f490611a60565b80601f016020809104026020016040519081016040528092919081815260200182805461062090611a60565b801561066d5780601f106106425761010080835404028352916020019161066d565b820191906000526020600020905b81548152906001019060200180831161065057829003601f168201915b5050505050815260200190600101906105d5565b6060601e805480602002602001604051908101604052809291908181526020016000905b8282101561037b5760008481526020908190206040805180820182526002860290920180546001600160a01b0316835260018101805483518187028101870190945280845293949193858301939283018282801561074f57602002820191906000526020600020906000905b82829054906101000a900460e01b6001600160e01b031916815260200190600401906020826003010492830192600103820291508084116107115790505b505050505081525050815260200190600101906106a5565b604080516002808252606080830184529260208301908036833701905050905063ee84621760e01b816000815181106107a2576107a2611a9a565b6001600160e01b031990921660209283029190910190910152805163604db38360e11b90829060019081106107d9576107d9611a9a565b6001600160e01b03199092166020928302919091019091015290565b6060601d805480602002602001604051908101604052809291908181526020016000905b8282101561037b5760008481526020908190206040805180820182526002860290920180546001600160a01b031683526001810180548351818702810187019094528084529394919385830193928301828280156108c357602002820191906000526020600020906000905b82829054906101000a900460e01b6001600160e01b031916815260200190600401906020826003010492830192600103820291508084116108855790505b50505050508152505081526020019060010190610819565b6060601a805480602002602001604051908101604052809291908181526020016000905b8282101561037b57838290600052602060002001805461091e90611a60565b80601f016020809104026020016040519081016040528092919081815260200182805461094a90611a60565b80156109975780601f1061096c57610100808354040283529160200191610997565b820191906000526020600020905b81548152906001019060200180831161097a57829003601f168201915b5050505050815260200190600101906108ff565b60095460009060ff16156109c3575060095460ff1690565b604051630667f9d760e41b8152737109709ecfa91a80626ff3989d68f67f5b1dd12d600482018190526519985a5b195960d21b602483015260009163667f9d7090604401602060405180830381865afa158015610a24573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610a489190611ab0565b1415905090565b602254600114610a9b5760405162461bcd60e51b8152602060048201526012602482015271736f6d65496e697456616c756520213d203160701b60448201526064015b60405180910390fd5b6000600080516020611af18339815191526001600160a01b03166331fadddf6040518163ffffffff1660e01b8152600401602060405180830381865afa158015610ae9573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610b0d9190611ab0565b600214610b475760405162461bcd60e51b81526020600482015260086024820152673b30b610109e901960c11b6044820152606401610a92565b600080516020611af18339815191526001600160a01b03166331fadddf6040518163ffffffff1660e01b8152600401602060405180830381865afa158015610b93573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610bb79190611ab0565b60216000828254610bc89190611ac9565b92505081905550600080516020611af18339815191526001600160a01b03166331fadddf6040518163ffffffff1660e01b8152600401602060405180830381865afa158015610c1b573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610c3f9190611ab0565b610c499082611ac9565b905060008054906101000a90046001600160a01b03166001600160a01b031663a09960eb6040518163ffffffff1660e01b8152600401600060405180830381600087803b158015610c9957600080fd5b505af1158015610cad573d6000803e3d6000fd5b50505050600080516020611af18339815191526001600160a01b03166331fadddf6040518163ffffffff1660e01b8152600401602060405180830381865afa158015610cfd573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610d219190611ab0565b600114610d635760405162461bcd60e51b815260206004820152601060248201526f7265616453746f7261676520213d203160801b6044820152606401610a92565b600080516020611af18339815191526001600160a01b03166331fadddf6040518163ffffffff1660e01b8152600401602060405180830381865afa158015610daf573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610dd39190611ab0565b60216000828254610de49190611ac9565b92505081905550600080516020611af18339815191526001600160a01b03166331fadddf6040518163ffffffff1660e01b8152600401602060405180830381865afa158015610e37573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610e5b9190611ab0565b610e659082611ac9565b905060008054906101000a90046001600160a01b03166001600160a01b03166370c0dc2e6040518163ffffffff1660e01b8152600401600060405180830381600087803b158015610eb557600080fd5b505af1158015610ec9573d6000803e3d6000fd5b50505050600080516020611af18339815191526001600160a01b03166331fadddf6040518163ffffffff1660e01b8152600401602060405180830381865afa158015610f19573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610f3d9190611ab0565b600214610f775760405162461bcd60e51b81526020600482015260086024820152673b30b610109e901960c11b6044820152606401610a92565b600080516020611af18339815191526001600160a01b03166331fadddf6040518163ffffffff1660e01b8152600401602060405180830381865afa158015610fc3573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610fe79190611ab0565b60216000828254610ff89190611ac9565b92505081905550600080516020611af18339815191526001600160a01b03166331fadddf6040518163ffffffff1660e01b8152600401602060405180830381865afa15801561104b573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061106f9190611ab0565b6110799082611ac9565b905060008054906101000a90046001600160a01b03166001600160a01b031663a09960eb6040518163ffffffff1660e01b8152600401600060405180830381600087803b1580156110c957600080fd5b505af11580156110dd573d6000803e3d6000fd5b50505050600080516020611af18339815191526001600160a01b03166331fadddf6040518163ffffffff1660e01b8152600401602060405180830381865afa15801561112d573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906111519190611ab0565b60011461118b5760405162461bcd60e51b815260206004820152600860248201526776616c20213d203160c01b6044820152606401610a92565b600080516020611af18339815191526001600160a01b03166331fadddf6040518163ffffffff1660e01b8152600401602060405180830381865afa1580156111d7573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906111fb9190611ab0565b6021600082825461120c9190611ac9565b92505081905550600080516020611af18339815191526001600160a01b03166331fadddf6040518163ffffffff1660e01b8152600401602060405180830381865afa15801561125f573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906112839190611ab0565b61128d9082611ac9565b905060215481146112d55760405162461bcd60e51b815260206004820152601260248201527173756d20213d20657870656374656453756d60701b6044820152606401610a92565b806006146113105760405162461bcd60e51b815260206004820152600860248201526739bab690109e901b60c11b6044820152606401610a92565b50565b60606016805480602002602001604051908101604052809291908181526020018280548015610238576020028201919060005260206000209081546001600160a01b0316815260019091019060200180831161021a575050505050905090565b600080516020611af18339815191526001600160a01b03166331fadddf6040518163ffffffff1660e01b8152600401602060405180830381865afa1580156113bf573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906113e39190611ab0565b6002146114275760405162461bcd60e51b81526020600482015260126024820152713932b0b229ba37b930b3b2941490109e901960711b6044820152606401610a92565b600080546040805163a09960eb60e01b815290516001600160a01b039092169263a09960eb9260048084019382900301818387803b15801561146857600080fd5b505af115801561147c573d6000803e3d6000fd5b50505050600080516020611af18339815191526001600160a01b03166331fadddf6040518163ffffffff1660e01b8152600401602060405180830381865afa1580156114cc573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906114f09190611ab0565b6001146115345760405162461bcd60e51b81526020600482015260126024820152717265616453746f72616765282920213d203160701b6044820152606401610a92565b60008054604080516338606e1760e11b815290516001600160a01b03909216926370c0dc2e9260048084019382900301818387803b15801561157557600080fd5b505af1158015611589573d6000803e3d6000fd5b50505050600080516020611af18339815191526001600160a01b03166331fadddf6040518163ffffffff1660e01b8152600401602060405180830381865afa1580156115d9573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906115fd9190611ab0565b6002146116415760405162461bcd60e51b81526020600482015260126024820152713932b0b229ba37b930b3b2941490109e901960711b6044820152606401610a92565b600080546040805163a09960eb60e01b815290516001600160a01b039092169263a09960eb9260048084019382900301818387803b15801561168257600080fd5b505af1158015611696573d6000803e3d6000fd5b50505050600080516020611af18339815191526001600160a01b03166331fadddf6040518163ffffffff1660e01b8152600401602060405180830381865afa1580156116e6573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061170a9190611ab0565b60011461174e5760405162461bcd60e51b81526020600482015260126024820152717265616453746f72616765282920213d203160701b6044820152606401610a92565b565b602080825282518282018190526000918401906040840190835b818110156117915783516001600160a01b031683526020938401939092019160010161176a565b509095945050505050565b6000815180845260005b818110156117c2576020818501810151868301820152016117a6565b506000602082860101526020601f19601f83011685010191505092915050565b6000602082016020835280845180835260408501915060408160051b86010192506020860160005b828110156118a257603f19878603018452815180516001600160a01b03168652602090810151604082880181905281519088018190529101906060600582901b88018101919088019060005b8181101561188857605f198a850301835261187284865161179c565b6020958601959094509290920191600101611856565b50919750505060209485019492909201915060010161180a565b50929695505050505050565b600081518084526020840193506020830160005b828110156118ea5781516001600160e01b0319168652602095860195909101906001016118c2565b5093949350505050565b6000602082016020835280845180835260408501915060408160051b86010192506020860160005b828110156118a257603f198786030184528151805160408752611942604088018261179c565b905060208201519150868103602088015261195d81836118ae565b96505050602093840193919091019060010161191c565b6000602082016020835280845180835260408501915060408160051b86010192506020860160005b828110156118a257603f198786030184526119b885835161179c565b9450602093840193919091019060010161199c565b6000602082016020835280845180835260408501915060408160051b86010192506020860160005b828110156118a257868503603f19018452815180516001600160a01b03168652602090810151604091870182905290611a30908701826118ae565b95505060209384019391909101906001016119f5565b602081526000611a5960208301846118ae565b9392505050565b600181811c90821680611a7457607f821691505b602082108103611a9457634e487b7160e01b600052602260045260246000fd5b50919050565b634e487b7160e01b600052603260045260246000fd5b600060208284031215611ac257600080fd5b5051919050565b80820180821115611aea57634e487b7160e01b600052601160045260246000fd5b9291505056fe000000000000000000000000118dd24a3b0d02f90d8896e242d3838b4d37c181a2646970667358221220f9736c1b3cbd5184e0cf247f00d01a39ec342936adf012265b2b4e872372d30964736f6c634300081a0033");

        assertion_store
            .insert(target, vec![Bytecode::LegacyRaw(assertion_code)])
            .unwrap();

        let mut executor = AssertionExecutor {
            db,
            assertion_store_reader: assertion_store.reader(),
            spec_id: SpecId::LATEST,
            chain_id: 1,
        };

        // Deploy mock using deployed bytecode of contract-mocks/src/ForkTest.sol:Target
        let target_deployment_tx = TxEnv {
            caller,
            data: bytes!("6080604052600160005560ac8060166000396000f3fe6080604052348015600f57600080fd5b506004361060325760003560e01c806331fadddf14603757806341720c3e14604c575b600080fd5b60005460405190815260200160405180910390f35b605c6057366004605e565b600055565b005b600060208284031215606f57600080fd5b503591905056fea2646970667358221220aa3043d43c0c31a9b0cf2277c4783fb1d2e393e495436274f9bffdfae8d1744264736f6c63430008190033"),
            transact_to: TxKind::Create,
            ..Default::default()
        };

        // Execute target deployment tx
        executor
            .execute_forked_tx(BlockEnv::default(), target_deployment_tx, &mut fork_db)
            .unwrap();

        // Deploy TriggeringTx contract using deployment bytecode of
        // contract-mocks/src/ForkTest.sol:TriggeringTx
        let trigger_tx = TxEnv {
            caller,
            data: bytes!("608060408190526320b9061f60e11b9052600260845273118dd24a3b0d02f90d8896e242d3838b4d37c1816341720c3e60a4600060405180830381600087803b158015604a57600080fd5b505af1158015605d573d6000803e3d6000fd5b50505050603f80606e6000396000f3fe6080604052600080fdfea26469706673582212208a1e5d50c2e8b17c40ea496fc11af9969c32b4f6e4c4f328926409d757ecae4b64736f6c63430008190033"),
            transact_to: TxKind::Create,
            ..Default::default()
        };

        //Execute triggering tx.
        assert!(executor
            .validate_transaction(BlockEnv::default(), trigger_tx, &mut fork_db)
            .await
            .unwrap()
            .is_some());
    }
}
