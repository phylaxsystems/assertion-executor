use crate::{
    db::{
        multi_fork_db::{
            ForkError,
            ForkId,
            MultiForkDb,
        },
        DatabaseRef,
    },
    primitives::{
        address,
        bytes,
        Address,
        Bytecode,
        Bytes,
        JournaledState,
        U256,
    },
};

use alloy_sol_types::{
    sol,
    SolCall,
    SolError,
};

use revm::{
    interpreter::{
        CallInputs,
        CallOutcome,
        CreateInputs,
        CreateOutcome,
        Gas,
        InstructionResult,
        Interpreter,
        InterpreterResult,
    },
    precompile::{
        PrecompileSpecId,
        Precompiles,
    },
    primitives::SpecId,
    EvmContext,
    InnerEvmContext,
    Inspector,
};

/// Precompile address
/// address(uint160(uint256(keccak256("Kim Jong Un Sucks"))))
pub const PRECOMPILE_ADDRESS: Address = address!("4461812e00718ff8D80929E3bF595AEaaa7b881E");

sol! {
    interface PhEvm {
        //Forks to the state prior to the assertion triggering transaction.
        function forkPreState() external;

        //Forks to the state after the assertion triggering transaction.
        function forkPostState() external;
    }

    //Default require error
    error Error(string);
}

/// PhEvmInspector is an inspector for supporting the PhEvm precompiles.
pub struct PhEvmInspector {
    init_journaled_state: JournaledState,
}

impl PhEvmInspector {
    /// Create a new PhEvmInspector.
    pub fn new(spec_id: SpecId) -> Self {
        let init_journaled_state = JournaledState::new(
            spec_id,
            Precompiles::new(PrecompileSpecId::from_spec_id(spec_id))
                .addresses()
                .copied()
                .collect(),
        );
        PhEvmInspector {
            init_journaled_state,
        }
    }

    /// Execute precompile functions for the PhEvm.
    pub fn execute_precompile(
        &self,
        context: &mut EvmContext<MultiForkDb<impl DatabaseRef + Clone>>,
        inputs: &mut CallInputs,
    ) -> CallOutcome {
        let gas = Gas::new(inputs.gas_limit);

        match inputs
            .input
            .as_ref()
            .get(0..4)
            .unwrap_or_default()
            .try_into()
            .unwrap_or_default()
        {
            PhEvm::forkPreStateCall::SELECTOR => {
                let InnerEvmContext {
                    ref mut db,
                    ref mut journaled_state,
                    ..
                } = context.inner;

                let result =
                    db.switch_fork(ForkId::PreTx, journaled_state, &self.init_journaled_state);
                fork_result_to_call_outcome(result, gas)
            }
            PhEvm::forkPostStateCall::SELECTOR => {
                let InnerEvmContext {
                    ref mut db,
                    ref mut journaled_state,
                    ..
                } = context.inner;

                let result =
                    db.switch_fork(ForkId::PostTx, journaled_state, &self.init_journaled_state);

                fork_result_to_call_outcome(result, gas)
            }
            _ => {
                CallOutcome {
                    result: InterpreterResult {
                        result: InstructionResult::Revert,
                        output: Bytes::default(),
                        gas,
                    },
                    memory_offset: 0..0,
                }
            }
        }
    }
}

/// Convert a fork result to a call outcome.
/// Uses the default require [`Error`] signature for encoding revert messages.
fn fork_result_to_call_outcome(result: Result<(), ForkError>, gas: Gas) -> CallOutcome {
    match result {
        Ok(()) => {
            CallOutcome {
                result: InterpreterResult {
                    result: InstructionResult::Stop,
                    output: Bytes::default(),
                    gas,
                },
                memory_offset: 0..0,
            }
        }
        Err(e) => {
            CallOutcome {
                result: InterpreterResult {
                    result: InstructionResult::Revert,
                    output: Error::abi_encode(&Error { _0: e.to_string() }).into(),
                    gas,
                },
                memory_offset: 0..0,
            }
        }
    }
}

impl<DB: DatabaseRef + Clone> Inspector<MultiForkDb<DB>> for PhEvmInspector {
    fn initialize_interp(
        &mut self,
        _interp: &mut Interpreter,
        _context: &mut EvmContext<MultiForkDb<DB>>,
    ) {
    }

    fn step(&mut self, _interp: &mut Interpreter, _context: &mut EvmContext<MultiForkDb<DB>>) {}

    fn step_end(&mut self, _interp: &mut Interpreter, _context: &mut EvmContext<MultiForkDb<DB>>) {}

    fn call_end(
        &mut self,
        _context: &mut EvmContext<MultiForkDb<DB>>,
        _inputs: &CallInputs,
        outcome: CallOutcome,
    ) -> CallOutcome {
        outcome
    }

    fn create_end(
        &mut self,
        _context: &mut EvmContext<MultiForkDb<DB>>,
        _inputs: &CreateInputs,
        outcome: CreateOutcome,
    ) -> CreateOutcome {
        outcome
    }

    fn call(
        &mut self,
        context: &mut EvmContext<MultiForkDb<DB>>,
        inputs: &mut CallInputs,
    ) -> Option<CallOutcome> {
        if inputs.target_address == PRECOMPILE_ADDRESS {
            return Some(self.execute_precompile(context, inputs));
        }
        None
    }

    fn create(
        &mut self,
        _context: &mut EvmContext<MultiForkDb<DB>>,
        _inputs: &mut CreateInputs,
    ) -> Option<CreateOutcome> {
        None
    }

    fn selfdestruct(&mut self, _contract: Address, _target: Address, _value: U256) {}
}

/// Insert the precompile account into the database.
pub fn insert_precompile_account<T: DatabaseRef + Clone>(db: &mut MultiForkDb<T>) {
    db.active_db.insert_account_info(
        PRECOMPILE_ADDRESS,
        crate::primitives::AccountInfo {
            code: Some(Bytecode::new_raw(bytes!("45"))),
            ..Default::default()
        },
    );
}

#[cfg(test)]
mod test {
    use super::*;
    use crate::{
        db::SharedDB,
        primitives::{
            address,
            AssertionContract,
            BlockEnv,
            Bytecode,
            TxEnv,
            TxKind,
        },
        store::AssertionStore,
        AssertionExecutor,
    };
    use revm::primitives::{
        bytes,
        fixed_bytes,
    };

    #[test]
    fn test_fork_switching() {
        let caller = address!("5fdcca53617f4d2b9134b29090c87d01058e27e9");
        let target = address!("118dd24a3b0d02f90d8896e242d3838b4d37c181");

        let db = SharedDB::<0>::new_test();

        let assertion_store = AssertionStore::default();

        let mut fork_db = db.fork();

        // Write test assertion to assertion store
        let test_fork_switch_selector = fixed_bytes!("ee846217");
        let test_persist_target_contracts_selector = fixed_bytes!("c09b6706");

        // deployment bytecode of contract-mocks/src/ForkTest.sol:ForkTest
        let assertion_code = bytes!("6080604052600080546001600160a01b031916734461812e00718ff8d80929e3bf595aeaaa7b881e178155600d805460ff19908116600190811790925560208054909116821790556021829055602255611a6790819061005f90396000f3fe608060405234801561001057600080fd5b50600436106100ea5760003560e01c8063b0464fdc1161008c578063c09b670611610066578063c09b670614610199578063e20c9f71146101a3578063ee846217146101ab578063fa7626d4146101b357600080fd5b8063b0464fdc14610171578063b5508aa914610179578063ba414fa61461018157600080fd5b80633f7286f4116100c85780633f7286f41461012a57806366d9a9a01461013257806385226c8114610147578063916a17c61461015c57600080fd5b80631ed7831c146100ef5780632ade38801461010d5780633e5e3c2314610122575b600080fd5b6100f76101c0565b60405161010491906116a2565b60405180910390f35b610115610222565b6040516101049190611735565b6100f7610364565b6100f76103c4565b61013a610424565b604051610104919061183b565b61014f610591565b60405161010491906118c2565b610164610661565b6040516101049190611926565b610164610747565b61014f61082d565b6101896108fd565b6040519015158152602001610104565b6101a16109a1565b005b6100f7611265565b6101a16112c5565b6020546101899060ff1681565b6060601780548060200260200160405190810160405280929190818152602001828054801561021857602002820191906000526020600020905b81546001600160a01b031681526001909101906020018083116101fa575b5050505050905090565b6060601f805480602002602001604051908101604052809291908181526020016000905b8282101561035b57600084815260208082206040805180820182526002870290920180546001600160a01b03168352600181018054835181870281018701909452808452939591948681019491929084015b828210156103445783829060005260206000200180546102b790611997565b80601f01602080910402602001604051908101604052809291908181526020018280546102e390611997565b80156103305780601f1061030557610100808354040283529160200191610330565b820191906000526020600020905b81548152906001019060200180831161031357829003601f168201915b505050505081526020019060010190610298565b505050508152505081526020019060010190610246565b50505050905090565b60606019805480602002602001604051908101604052809291908181526020018280548015610218576020028201919060005260206000209081546001600160a01b031681526001909101906020018083116101fa575050505050905090565b60606018805480602002602001604051908101604052809291908181526020018280548015610218576020028201919060005260206000209081546001600160a01b031681526001909101906020018083116101fa575050505050905090565b6060601c805480602002602001604051908101604052809291908181526020016000905b8282101561035b578382906000526020600020906002020160405180604001604052908160008201805461047b90611997565b80601f01602080910402602001604051908101604052809291908181526020018280546104a790611997565b80156104f45780601f106104c9576101008083540402835291602001916104f4565b820191906000526020600020905b8154815290600101906020018083116104d757829003601f168201915b505050505081526020016001820180548060200260200160405190810160405280929190818152602001828054801561057957602002820191906000526020600020906000905b82829054906101000a900460e01b6001600160e01b0319168152602001906004019060208260030104928301926001038202915080841161053b5790505b50505050508152505081526020019060010190610448565b6060601b805480602002602001604051908101604052809291908181526020016000905b8282101561035b5783829060005260206000200180546105d490611997565b80601f016020809104026020016040519081016040528092919081815260200182805461060090611997565b801561064d5780601f106106225761010080835404028352916020019161064d565b820191906000526020600020905b81548152906001019060200180831161063057829003601f168201915b5050505050815260200190600101906105b5565b6060601e805480602002602001604051908101604052809291908181526020016000905b8282101561035b5760008481526020908190206040805180820182526002860290920180546001600160a01b0316835260018101805483518187028101870190945280845293949193858301939283018282801561072f57602002820191906000526020600020906000905b82829054906101000a900460e01b6001600160e01b031916815260200190600401906020826003010492830192600103820291508084116106f15790505b50505050508152505081526020019060010190610685565b6060601d805480602002602001604051908101604052809291908181526020016000905b8282101561035b5760008481526020908190206040805180820182526002860290920180546001600160a01b0316835260018101805483518187028101870190945280845293949193858301939283018282801561081557602002820191906000526020600020906000905b82829054906101000a900460e01b6001600160e01b031916815260200190600401906020826003010492830192600103820291508084116107d75790505b5050505050815250508152602001906001019061076b565b6060601a805480602002602001604051908101604052809291908181526020016000905b8282101561035b57838290600052602060002001805461087090611997565b80601f016020809104026020016040519081016040528092919081815260200182805461089c90611997565b80156108e95780601f106108be576101008083540402835291602001916108e9565b820191906000526020600020905b8154815290600101906020018083116108cc57829003601f168201915b505050505081526020019060010190610851565b60095460009060ff1615610915575060095460ff1690565b604051630667f9d760e41b8152737109709ecfa91a80626ff3989d68f67f5b1dd12d600482018190526519985a5b195960d21b602483015260009163667f9d7090604401602060405180830381865afa158015610976573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061099a91906119d1565b1415905090565b6022546001146109ed5760405162461bcd60e51b8152602060048201526012602482015271736f6d65496e697456616c756520213d203160701b60448201526064015b60405180910390fd5b6000600080516020611a128339815191526001600160a01b03166331fadddf6040518163ffffffff1660e01b8152600401602060405180830381865afa158015610a3b573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610a5f91906119d1565b600214610a995760405162461bcd60e51b81526020600482015260086024820152673b30b610109e901960c11b60448201526064016109e4565b600080516020611a128339815191526001600160a01b03166331fadddf6040518163ffffffff1660e01b8152600401602060405180830381865afa158015610ae5573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610b0991906119d1565b60216000828254610b1a91906119ea565b92505081905550600080516020611a128339815191526001600160a01b03166331fadddf6040518163ffffffff1660e01b8152600401602060405180830381865afa158015610b6d573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610b9191906119d1565b610b9b90826119ea565b905060008054906101000a90046001600160a01b03166001600160a01b031663a09960eb6040518163ffffffff1660e01b8152600401600060405180830381600087803b158015610beb57600080fd5b505af1158015610bff573d6000803e3d6000fd5b50505050600080516020611a128339815191526001600160a01b03166331fadddf6040518163ffffffff1660e01b8152600401602060405180830381865afa158015610c4f573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610c7391906119d1565b600114610cb55760405162461bcd60e51b815260206004820152601060248201526f7265616453746f7261676520213d203160801b60448201526064016109e4565b600080516020611a128339815191526001600160a01b03166331fadddf6040518163ffffffff1660e01b8152600401602060405180830381865afa158015610d01573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610d2591906119d1565b60216000828254610d3691906119ea565b92505081905550600080516020611a128339815191526001600160a01b03166331fadddf6040518163ffffffff1660e01b8152600401602060405180830381865afa158015610d89573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610dad91906119d1565b610db790826119ea565b905060008054906101000a90046001600160a01b03166001600160a01b03166370c0dc2e6040518163ffffffff1660e01b8152600401600060405180830381600087803b158015610e0757600080fd5b505af1158015610e1b573d6000803e3d6000fd5b50505050600080516020611a128339815191526001600160a01b03166331fadddf6040518163ffffffff1660e01b8152600401602060405180830381865afa158015610e6b573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610e8f91906119d1565b600214610ec95760405162461bcd60e51b81526020600482015260086024820152673b30b610109e901960c11b60448201526064016109e4565b600080516020611a128339815191526001600160a01b03166331fadddf6040518163ffffffff1660e01b8152600401602060405180830381865afa158015610f15573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610f3991906119d1565b60216000828254610f4a91906119ea565b92505081905550600080516020611a128339815191526001600160a01b03166331fadddf6040518163ffffffff1660e01b8152600401602060405180830381865afa158015610f9d573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610fc191906119d1565b610fcb90826119ea565b905060008054906101000a90046001600160a01b03166001600160a01b031663a09960eb6040518163ffffffff1660e01b8152600401600060405180830381600087803b15801561101b57600080fd5b505af115801561102f573d6000803e3d6000fd5b50505050600080516020611a128339815191526001600160a01b03166331fadddf6040518163ffffffff1660e01b8152600401602060405180830381865afa15801561107f573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906110a391906119d1565b6001146110dd5760405162461bcd60e51b815260206004820152600860248201526776616c20213d203160c01b60448201526064016109e4565b600080516020611a128339815191526001600160a01b03166331fadddf6040518163ffffffff1660e01b8152600401602060405180830381865afa158015611129573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061114d91906119d1565b6021600082825461115e91906119ea565b92505081905550600080516020611a128339815191526001600160a01b03166331fadddf6040518163ffffffff1660e01b8152600401602060405180830381865afa1580156111b1573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906111d591906119d1565b6111df90826119ea565b905060215481146112275760405162461bcd60e51b815260206004820152601260248201527173756d20213d20657870656374656453756d60701b60448201526064016109e4565b806006146112625760405162461bcd60e51b815260206004820152600860248201526739bab690109e901b60c11b60448201526064016109e4565b50565b60606016805480602002602001604051908101604052809291908181526020018280548015610218576020028201919060005260206000209081546001600160a01b031681526001909101906020018083116101fa575050505050905090565b600080516020611a128339815191526001600160a01b03166331fadddf6040518163ffffffff1660e01b8152600401602060405180830381865afa158015611311573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061133591906119d1565b6002146113795760405162461bcd60e51b81526020600482015260126024820152713932b0b229ba37b930b3b2941490109e901960711b60448201526064016109e4565b600080546040805163a09960eb60e01b815290516001600160a01b039092169263a09960eb9260048084019382900301818387803b1580156113ba57600080fd5b505af11580156113ce573d6000803e3d6000fd5b50505050600080516020611a128339815191526001600160a01b03166331fadddf6040518163ffffffff1660e01b8152600401602060405180830381865afa15801561141e573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061144291906119d1565b6001146114865760405162461bcd60e51b81526020600482015260126024820152717265616453746f72616765282920213d203160701b60448201526064016109e4565b60008054604080516338606e1760e11b815290516001600160a01b03909216926370c0dc2e9260048084019382900301818387803b1580156114c757600080fd5b505af11580156114db573d6000803e3d6000fd5b50505050600080516020611a128339815191526001600160a01b03166331fadddf6040518163ffffffff1660e01b8152600401602060405180830381865afa15801561152b573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061154f91906119d1565b6002146115935760405162461bcd60e51b81526020600482015260126024820152713932b0b229ba37b930b3b2941490109e901960711b60448201526064016109e4565b600080546040805163a09960eb60e01b815290516001600160a01b039092169263a09960eb9260048084019382900301818387803b1580156115d457600080fd5b505af11580156115e8573d6000803e3d6000fd5b50505050600080516020611a128339815191526001600160a01b03166331fadddf6040518163ffffffff1660e01b8152600401602060405180830381865afa158015611638573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061165c91906119d1565b6001146116a05760405162461bcd60e51b81526020600482015260126024820152717265616453746f72616765282920213d203160701b60448201526064016109e4565b565b6020808252825182820181905260009190848201906040850190845b818110156116e35783516001600160a01b0316835292840192918401916001016116be565b50909695505050505050565b6000815180845260005b81811015611715576020818501810151868301820152016116f9565b506000602082860101526020601f19601f83011685010191505092915050565b602080825282518282018190526000919060409081850190600581811b8701840188860187805b858110156117e557603f198b8503018752825180516001600160a01b031685528901518985018990528051898601819052908a0190606081881b870181019190870190855b818110156117cf57605f198985030183526117bd8486516116ef565b948e01949350918d01916001016117a1565b505050978a01979450509188019160010161175c565b50919a9950505050505050505050565b60008151808452602080850194506020840160005b838110156118305781516001600160e01b0319168752958201959082019060010161180a565b509495945050505050565b600060208083018184528085518083526040925060408601915060408160051b87010184880160005b838110156118b457888303603f1901855281518051878552611888888601826116ef565b91890151858303868b01529190506118a081836117f5565b968901969450505090860190600101611864565b509098975050505050505050565b600060208083016020845280855180835260408601915060408160051b87010192506020870160005b8281101561191957603f198886030184526119078583516116ef565b945092850192908501906001016118eb565b5092979650505050505050565b600060208083018184528085518083526040925060408601915060408160051b87010184880160005b838110156118b457888303603f19018552815180516001600160a01b03168452870151878401879052611984878501826117f5565b958801959350509086019060010161194f565b600181811c908216806119ab57607f821691505b6020821081036119cb57634e487b7160e01b600052602260045260246000fd5b50919050565b6000602082840312156119e357600080fd5b5051919050565b80820180821115611a0b57634e487b7160e01b600052601160045260246000fd5b9291505056fe000000000000000000000000118dd24a3b0d02f90d8896e242d3838b4d37c181a2646970667358221220200dd5d24cea733f2c6fe4fa1e0647302a0a7df630aa0823757400b9557a8fbc64736f6c63430008190033");

        let writer = assertion_store.writer();
        writer
            .write_sync(
                U256::ZERO,
                vec![(
                    target,
                    vec![AssertionContract {
                        fn_selectors: vec![
                            test_fork_switch_selector,
                            test_persist_target_contracts_selector,
                        ],
                        code: Bytecode::new_raw(assertion_code.clone()),
                        code_hash: revm::primitives::keccak256(&assertion_code),
                    }],
                )],
            )
            .unwrap();

        let mut executor = AssertionExecutor {
            db,
            assertion_store_reader: assertion_store.reader(),
            spec_id: SpecId::LATEST,
        };

        // Deploy mock using deployed bytecode of contract-mocks/src/ForkTest.sol:Target
        let target_deployment_tx = TxEnv {
            caller,
            data: bytes!("6080604052600160005560ac8060166000396000f3fe6080604052348015600f57600080fd5b506004361060325760003560e01c806331fadddf14603757806341720c3e14604c575b600080fd5b60005460405190815260200160405180910390f35b605c6057366004605e565b600055565b005b600060208284031215606f57600080fd5b503591905056fea2646970667358221220aa3043d43c0c31a9b0cf2277c4783fb1d2e393e495436274f9bffdfae8d1744264736f6c63430008190033"),
            transact_to: TxKind::Create,
            ..Default::default()
        };

        // Execute target deployment tx
        executor
            .execute_forked_tx(BlockEnv::default(), target_deployment_tx, &mut fork_db)
            .unwrap();

        // Deploy TriggeringTx contract using deployment bytecode of
        // contract-mocks/src/ForkTest.sol:TriggeringTx
        let trigger_tx = TxEnv {
            caller,
            data: bytes!("608060408190526320b9061f60e11b9052600260845273118dd24a3b0d02f90d8896e242d3838b4d37c1816341720c3e60a4600060405180830381600087803b158015604a57600080fd5b505af1158015605d573d6000803e3d6000fd5b50505050603f80606e6000396000f3fe6080604052600080fdfea26469706673582212208a1e5d50c2e8b17c40ea496fc11af9969c32b4f6e4c4f328926409d757ecae4b64736f6c63430008190033"),
            transact_to: TxKind::Create,
            ..Default::default()
        };

        //Execute triggering tx.
        assert!(executor
            .validate_transaction(BlockEnv::default(), trigger_tx, &mut fork_db)
            .unwrap()
            .is_some());
    }
}
