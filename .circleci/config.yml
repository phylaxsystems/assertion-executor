version: 2.1

executors:
  foundry:
    docker:
      - image: ghcr.io/foundry-rs/foundry:latest
    working_directory: /mnt/ramdisk
  rust:
    docker:
      - image: cimg/rust:1.82
    working_directory: /mnt/ramdisk

commands:
  git-auth:
    steps:
      - run:
          name: Configure Git Auth
          command: |
            git config --global url."https://$GITHUB_TOKEN@github.com".insteadOf ssh://git@github.com
            git config --global url."https://$GITHUB_TOKEN@github.com/".insteadOf git@github.com:
  install-deps:
    steps:
      - run:
          name: Install Dependencies
          command: |
            sudo apt update && sudo apt install --yes clang
  build-contracts:
    steps:
      - run:
          name: Build Smart Contracts
          command: |
            forge build --root contract-mocks

references:
  onlyMasterBranch: &onlyMasterBranch
    filters:
      branches:
        only:
          - main
  context: &context
    context:
      - phylax

jobs:
  build:
    executor: rust
    steps:
      - checkout
      - install-deps
      - git-auth
      - run:
          name: Build artifacts
          command: make build
      - persist_to_workspace:
          root: ./
          paths:
            - .cargo/
            - target/
  forge-build:
    executor: foundry
    steps:
      - checkout
      - git-auth
      - run:
          name: Build smart contract mocks
          command: forge build --root contract-mocks
      - persist_to_workspace:
          root: ./
          paths:
            - contract-mocks/
  format:
    executor: rust
    steps:
      - checkout
      - git-auth
      - run:
          name: Check code formatting
          command: make format
  lint:
    executor: rust
    steps:
      - checkout
      - install-deps
      - git-auth
      - run:
          name: Run linter
          command: make lint
  unit-test:
    executor: rust
    steps:
      - checkout
      - install-deps
      - git-auth
      - attach_workspace:
          at: .
      - run:
          name: Run unit tests
          command: make test

workflows:
  Test and Build:
    jobs:
      - forge-build:
          name: Build Smart Contracts
          <<: *context
      - unit-test:
          name: Unit Tests
          requires:
            - Build Smart Contracts
          <<: *context
      - lint:
          name: Lint
          <<: *context
      - format:
          name: Format
          <<: *context
      - build:
          name: Build
          requires:
            - Unit Tests
            - Lint
            - Format
          <<: *context
          <<: *onlyMasterBranch
